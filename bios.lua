local a,b=table.insert,table.concat;local c,d=component.list,component.proxy;local e=d(c("eeprom",true)())local f,g;local function h(i,j)return("<I"..j):pack(i)end;local function k(l)return("<I"..#l):unpack(l)end;local function m(n)local o={}local p=n:gmatch("[0-9a-f][0-9a-f]")for q=1,16 do a(o,string.char(tonumber(p(),16)))end;return b(o)end;local function r(l)local s={}for q=1,16 do a(s,("%.2x"):format(l:byte(q)))if q>=4 and q<=10 and q%2==0 then a(s,"-")end end;return b(s)end;local function t(s)for u in c("drive",true)do if u:sub(1,#s)==s then return u end end end;do local v=e.getData()local w=k(v:sub(21,24))if w==2 then f=0 elseif w==0 or w==1 then local s=r(v:sub(1,16))local x=k(v:sub(17,20))local d=d(s)if d and d.type=="drive"then local y=d.readSector(1)if y:sub(1,4)=="OCPT"then local z=k(y:sub(5,8))if z>>x&1==1 then local A=128+x*12;local B=y:sub(A+1,A+12)if x<32 and k(B:sub(11,12))==0 and k(B:sub(9,10))&1==1 then local C=k(B:sub(1,4))local D=k(B:sub(5,8))local E={}for F=1,D do a(E,d.readSector(C+F))end;f=2;g=b(E)else g="partition not bootable"end else g="unknown partition"end else g="no partition table"end else g="drive unavailable"end;if f~=2 then f=w==0 and 0 or 1 end elseif w==3 or w==4 then local G=v:sub(24)local H=c("internet",true)()if H then H=d(H)local I,J=H.request(G)if I then local E={}while true do local v,J=I.read()if not v then I.close()if J then g=J else f=2;g=b(E)end;break elseif#v>0 then a(E,v)else computer.pullSignal(0)end end else g=J end else g="no internet card"end;if f~=2 then f=w==3 and 0 or 1 end else f=0;g="invalid boot mode"end end;if f==1 or not(c("gpu",true)()and c("screen",true)())then error(g or"unknown error")elseif f==2 then assert(load(g,"=bios"))()return end;do local v=e.getData()local K=d(c("gpu",true)())local L,M=1,1;local N,O;K.bind(c("screen",true)(),true)K.setResolution(K.maxResolution())N,O=K.getResolution()local function P()K.copy(1,4,N,O-3,0,-1)K.fill(1,O,N,1," ")end;local function Q()L=1;M=M+1;while M>=O do P()M=M-1 end end;local function R(l)local S,T;if L>N then S=N;Q()else S=N-L+1 end;T=unicode.len(l)if T>S then local U=unicode.wtrunc(l,S)l=unicode.sub(l,S+1)K.set(L,M,U)Q()elseif T>0 then local U=unicode.sub(l,1,T)l=unicode.sub(l,T+1)K.set(L,M,U)L=L+T end;return l end;local function V(l)while#l>0 do l=R(l)end end;local function W(l)V(l)Q()end;local function X()if L==1 then L=N;M=M-1 else L=L-1 end;K.set(L,M," ")end;local function Y()local Z={}while true do local _,a0,a1=computer.pullSignal()if _=="key_down"then if a1>=0x20 then local v=unicode.char(a1)V(v)a(Z,v)elseif a1==13 then Q()return b(Z)elseif a1==8 and#Z>0 then table.remove(Z)X()end end end end;local function a2(l)local a3={}for a4 in l:gmatch("%S+")do a(a3,a4)end;return a3 end;K.fill(1,1,N,O," ")W("OCDT BIOS - v1.0")W(("-"):rep(N))W(("Boot result: %s."):format(g or"none"))W("Enter ? to view commands.")while true do local a5;V(">")a5=a2(Y())if a5[1]=="?"then W("?  Show commands.")W("a  Get/set boot address.")W("p  Get/set boot partition.")W("m  Get/set boot mode.")W("u  Get/set boot URL.")W("l  List drives.")W("x  Shutdown.")elseif a5[1]=="a"then local n=a5[2]if not n then W("usage: a [address]")W("Boot address: "..r(v:sub(1,16)))else local s=t(n)if s then v=m(s)..v:sub(17)e.setData(v)else W("Failed.")end end elseif a5[1]=="p"then local x=a5[2]if not x then W("usage: p [partition]")W("Boot partition: "..k(v:sub(17,20)))else x=tonumber(x)if x and x>=0 and x<31 and x%1==0 then v=v:sub(1,16)..h(x,4)..v:sub(21)e.setData(v)else W("Failed.")end end elseif a5[1]=="m"then local w=a5[2]if not w then W("usage: m [mode]")W("Boot mode: "..k(v:sub(21,24)))else w=tonumber(w)if w and w>=0 and w<2^32 then v=v:sub(1,20)..h(w,4)..v:sub(25)e.setData(v)else W("Failed.")end end elseif a5[1]=="u"then local G=a5[2]if not G then W("usage: u [url]")W("Boot URL: "..v:sub(25))else v=v:sub(1,24)..G;e.setData(v)end elseif a5[1]=="l"then local p=c("drive",true)for u in p do W("Drive: "..u)end elseif a5[1]=="x"then computer.shutdown()elseif a5[1]then W("Bad command.")end end end
